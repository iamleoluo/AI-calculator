# ğŸ“‹ å ±å‘ŠäºŒï¼šæŠ€è¡“å¯¦ä½œæ–¹æ¡ˆèˆ‡å»ºè­°ï¼ˆå…·é«”å±¤æ¬¡ï¼‰

---

## ä¸€ã€æ•´é«”æŠ€è¡“æ¶æ§‹

### 1.1 æŠ€è¡“æ£§é¸æ“‡

```yaml
å‰ç«¯:
  æ¡†æ¶: Next.js 14+ (React 18+)
  èªè¨€: TypeScript
  UI æ¡†æ¶: Tailwind CSS + shadcn/ui
  æ•¸å­¸æ¸²æŸ“: KaTeX
  åœ–è¡¨: Plotly.js
  ç‹€æ…‹ç®¡ç†: Zustand
  HTTP å®¢æˆ¶ç«¯: TanStack Query (React Query)

å¾Œç«¯:
  æ¡†æ¶: FastAPI (Python 3.11+)
  AI SDK: Anthropic Python SDK
  æ•¸å€¼è¨ˆç®—: NumPy, SciPy, SymPy
  API æ–‡ä»¶: FastAPI è‡ªå‹•ç”Ÿæˆ
  é©—è­‰: Pydantic

è³‡æ–™åº«:
  ä¸»è³‡æ–™åº«: PostgreSQL 15+
  å¿«å–: Redis 7+
  
éƒ¨ç½²:
  å‰ç«¯: Vercel
  å¾Œç«¯: Railway / Render / AWS ECS
  è³‡æ–™åº«: Supabase / AWS RDS
```

**ç‚ºä»€éº¼é€™æ¨£é¸æ“‡ï¼Ÿ**
- Next.js: å‰å¾Œç«¯åˆ†é›¢ï¼ŒSSR å„ªåŒ–ï¼Œéƒ¨ç½²ç°¡å–®
- FastAPI: ç•°æ­¥æ”¯æ´ï¼Œè‡ªå‹•æ–‡ä»¶ç”Ÿæˆï¼Œé¡å‹å®‰å…¨
- Anthropic: Claude çš„æ•¸å­¸èƒ½åŠ›å¼·ï¼Œé©åˆæ•™å­¸
- PostgreSQL: é—œè¯å¼è³‡æ–™åº«ï¼Œé©åˆçµæ§‹åŒ–æ•¸æ“š

---

## äºŒã€å°ˆæ¡ˆçµæ§‹

### 2.1 å‰ç«¯çµæ§‹

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ page.tsx           # é¦–é 
â”‚   â”‚   â”œâ”€â”€ demo/              # AI ç¤ºç¯„æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ practice/          # å­¸ç”Ÿç·´ç¿’æ¨¡å¼
â”‚   â”‚   â””â”€â”€ api/               # API Routes (é¸ç”¨)
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                # shadcn/ui åŸºç¤çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ latex-editor/      # LaTeX ç·¨è¼¯å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ Editor.tsx
â”‚   â”‚   â”‚   â””â”€â”€ Preview.tsx
â”‚   â”‚   â”œâ”€â”€ thinking-display/  # AI æ€è€ƒéç¨‹å±•ç¤º
â”‚   â”‚   â”‚   â”œâ”€â”€ StepCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FormulaDisplay.tsx
â”‚   â”‚   â”‚   â””â”€â”€ StepNavigation.tsx
â”‚   â”‚   â”œâ”€â”€ code-display/      # ç¨‹å¼ç¢¼å±•ç¤º
â”‚   â”‚   â”‚   â””â”€â”€ SyntaxHighlight.tsx
â”‚   â”‚   â”œâ”€â”€ visualization/     # è¦–è¦ºåŒ–çµ„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ PlotlyChart.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ComparisonView.tsx
â”‚   â”‚   â””â”€â”€ feedback/          # åé¥‹é¢æ¿
â”‚   â”‚       â””â”€â”€ FeedbackPanel.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ api/               # API å®¢æˆ¶ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”‚   â””â”€â”€ endpoints.ts
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ latex-parser.ts
â”‚   â”‚       â””â”€â”€ format.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/                # Zustand stores
â”‚   â”‚   â”œâ”€â”€ problem-store.ts
â”‚   â”‚   â””â”€â”€ ui-store.ts
â”‚   â”‚
â”‚   â””â”€â”€ types/                 # TypeScript é¡å‹å®šç¾©
â”‚       â”œâ”€â”€ api.ts
â”‚       â””â”€â”€ domain.ts
â”‚
â”œâ”€â”€ public/
â”‚   â””â”€â”€ images/
â”‚
â””â”€â”€ package.json
```

### 2.2 å¾Œç«¯çµæ§‹

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                # FastAPI app entry
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                   # API Routes
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ derivation.py  # AI æ¨å°ç›¸é—œ
â”‚   â”‚   â”‚   â”œâ”€â”€ verification.py# é©—è­‰ç›¸é—œ
â”‚   â”‚   â”‚   â””â”€â”€ student.py     # å­¸ç”Ÿäº’å‹•ç›¸é—œ
â”‚   â”‚   â””â”€â”€ deps.py            # ä¾è³´æ³¨å…¥
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                  # æ ¸å¿ƒæ¥­å‹™é‚è¼¯
â”‚   â”‚   â”œâ”€â”€ ai_engine.py       # AI å¼•æ“
â”‚   â”‚   â”œâ”€â”€ verification.py    # é©—è­‰å¼•æ“
â”‚   â”‚   â”œâ”€â”€ executor.py        # ç¨‹å¼ç¢¼åŸ·è¡Œå™¨
â”‚   â”‚   â””â”€â”€ config.py          # é…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ services/              # æ¥­å‹™æœå‹™
â”‚   â”‚   â”œâ”€â”€ fourier_service.py # å‚…ç«‹è‘‰ç´šæ•¸æœå‹™
â”‚   â”‚   â”œâ”€â”€ prompt_builder.py  # Prompt å»ºæ§‹å™¨
â”‚   â”‚   â””â”€â”€ error_analyzer.py  # èª¤å·®åˆ†æå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                # è³‡æ–™æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ problem.py
â”‚   â”‚   â”œâ”€â”€ solution.py
â”‚   â”‚   â””â”€â”€ verification.py
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/               # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ request.py
â”‚   â”‚   â””â”€â”€ response.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ math_utils.py
â”‚       â””â”€â”€ security.py        # å®‰å…¨åŸ·è¡Œæ²™ç®±
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_ai_engine.py
â”‚   â””â”€â”€ test_verification.py
â”‚
â”œâ”€â”€ requirements.txt
â””â”€â”€ .env.example
```

---

## ä¸‰ã€æ ¸å¿ƒæ¨¡çµ„å¯¦ä½œå»ºè­°

### 3.1 Prompt Builderï¼ˆPrompt å»ºæ§‹å™¨ï¼‰

**æª”æ¡ˆï¼š** `backend/app/services/prompt_builder.py`

**è·è²¬ï¼š**
- æ§‹å»ºç™¼é€çµ¦ Claude çš„ Prompt
- ç¢ºä¿æ ¼å¼è¦æ±‚æ¸…æ™°
- è™•ç†è¿­ä»£æ™‚çš„éŒ¯èª¤åé¥‹

**é—œéµæ–¹æ³•ï¼š**

```python
class PromptBuilder:
    def build_initial_prompt(
        self,
        latex_input: str,
        period: float,
        n_terms: int
    ) -> str:
        """æ§‹å»ºåˆå§‹ Prompt"""
        
    def build_feedback_prompt(
        self,
        latex_input: str,
        previous_response: dict,
        error_report: dict
    ) -> str:
        """æ§‹å»ºåé¥‹ Promptï¼ˆè¿­ä»£æ™‚ä½¿ç”¨ï¼‰"""
        
    def _get_output_format_spec(self) -> str:
        """ç²å–è¼¸å‡ºæ ¼å¼è¦ç¯„"""
        
    def _get_few_shot_examples(self) -> str:
        """ç²å– Few-shot ç¯„ä¾‹"""
```

**Prompt æ¨¡æ¿çµæ§‹ï¼š**

```python
INITIAL_PROMPT_TEMPLATE = """
ä½ æ˜¯æ•¸å­¸æ•™æˆå’Œç¨‹å¼å°ˆå®¶ã€‚è«‹åˆ†æå‚…ç«‹è‘‰ç´šæ•¸å•é¡Œã€‚

ã€è¼¸å…¥ã€‘
å‡½æ•¸: {latex_input}
é€±æœŸ: {period}
è¨ˆç®—é …æ•¸: {n_terms}

ã€è¼¸å‡ºè¦æ±‚ã€‘
å¿…é ˆè¿”å›åš´æ ¼çš„ JSON æ ¼å¼ï¼š

{{
  "thinking_process": {{
    "steps": [
      {{
        "step_number": 1,
        "title": "æ­¥é©Ÿæ¨™é¡Œ",
        "reasoning": "æ¨ç†éç¨‹",
        "formula_latex": "LaTeX å…¬å¼",
        "calculation_steps": ["æ­¥é©Ÿ1", "æ­¥é©Ÿ2"],
        "result": {{"value": 0.0, "latex": "çµæœ LaTeX"}}
      }}
    ]
  }},
  "executable_code": {{
    "imports": ["numpy as np", "scipy.integrate as integrate"],
    "function_original": "def f(t): return np.sin(t)",
    "function_reconstructed": "def f_fourier(t, coeffs): ...",
    "coefficients": {{
      "a0": 0.0,
      "an": [0.0, 0.0, ...],
      "bn": [1.0, 0.0, ...]
    }}
  }},
  "final_result": {{
    "latex": "f(t) = ..."
  }}
}}

ã€é—œéµç´„æŸ - executable_code éƒ¨åˆ†ã€‘
âš ï¸ é€™éƒ¨åˆ†å¿…é ˆæ¥µåº¦åš´æ ¼ âš ï¸
1. function_original å¿…é ˆæ˜¯å®Œæ•´å¯åŸ·è¡Œçš„ Python å‡½æ•¸
2. ä¸è¦åŒ…å« ```python æ¨™è¨˜
3. ä¸è¦åŒ…å«è¨»è§£
4. ç¢ºä¿èªæ³• 100% æ­£ç¢º
5. coefficients å¿…é ˆæ˜¯ç´”æ•¸å­—ï¼ˆfloatï¼‰ï¼Œä¸æ˜¯å­—ä¸²
6. å¯ä»¥ç›´æ¥ç”¨ exec() åŸ·è¡Œ

ã€ç¯„ä¾‹ã€‘
{few_shot_examples}

ç¾åœ¨è«‹è™•ç†ä¸Šè¿°è¼¸å…¥ã€‚
"""

FEEDBACK_PROMPT_TEMPLATE = """
ä¸Šæ¬¡è¨ˆç®—å­˜åœ¨èª¤å·®ï¼Œéœ€è¦é‡æ–°è¨ˆç®—ã€‚

ã€åŸå§‹å•é¡Œã€‘
å‡½æ•¸: {latex_input}

ã€ä¸Šæ¬¡çµæœã€‘
ä½ è¨ˆç®—çš„ä¿‚æ•¸: {ai_coefficients}

ã€é©—è­‰çµæœã€‘
æ•¸å€¼æ–¹æ³•è¨ˆç®—: {numerical_coefficients}
èª¤å·®: {error_percentage}%

ã€å•é¡Œåˆ†æã€‘
{error_analysis}

ã€å»ºè­°ã€‘
{suggestions}

è«‹é‡æ–°è¨ˆç®—ï¼Œç‰¹åˆ¥æ³¨æ„ï¼š
{specific_focus}

è¼¸å‡ºæ ¼å¼åŒä¸Šï¼ˆå¿…é ˆåŒ…å« thinking_process å’Œ executable_codeï¼‰ã€‚
"""
```

---

### 3.2 AI Engineï¼ˆAI å¼•æ“ï¼‰

**æª”æ¡ˆï¼š** `backend/app/core/ai_engine.py`

**è·è²¬ï¼š**
- å‘¼å« Claude API
- è§£æ AI è¿”å›çš„ JSON
- è™•ç†æ ¼å¼éŒ¯èª¤
- é‡è©¦æ©Ÿåˆ¶

**é—œéµæ–¹æ³•ï¼š**

```python
class AIEngine:
    def __init__(self, api_key: str):
        self.client = anthropic.Anthropic(api_key=api_key)
        self.max_retries = 3
        
    async def derive_fourier_series(
        self,
        prompt: str,
        temperature: float = 0.0
    ) -> dict:
        """
        å‘¼å« Claude API é€²è¡Œå‚…ç«‹è‘‰ç´šæ•¸æ¨å°
        è¿”å›è§£æå¾Œçš„ JSON
        """
        
    def _parse_response(self, response: str) -> dict:
        """è§£æ AI è¿”å›çš„ JSON"""
        
    def _validate_response(self, data: dict) -> bool:
        """é©—è­‰è¿”å›çš„ JSON æ ¼å¼"""
        
    def _fix_common_errors(self, response: str) -> str:
        """ä¿®æ­£å¸¸è¦‹çš„æ ¼å¼éŒ¯èª¤"""
```

**å‘¼å« Claude çš„è¨­å®šï¼š**

```python
response = self.client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=8192,  # è¶³å¤ é•·çš„è¼¸å‡º
    temperature=0.0,   # ç¢ºä¿ä¸€è‡´æ€§
    system="ä½ æ˜¯æ•¸å­¸å’Œç¨‹å¼è¨­è¨ˆå°ˆå®¶...",
    messages=[{
        "role": "user",
        "content": prompt
    }]
)
```

---

### 3.3 Code Executorï¼ˆç¨‹å¼ç¢¼åŸ·è¡Œå™¨ï¼‰

**æª”æ¡ˆï¼š** `backend/app/core/executor.py`

**è·è²¬ï¼š**
- å®‰å…¨åŸ·è¡Œ AI ç”Ÿæˆçš„ Python ç¨‹å¼ç¢¼
- æå–å‡½æ•¸å®šç¾©
- è¨ˆç®—æ•¸å€¼çµæœ

**å®‰å…¨è€ƒé‡ï¼š**

```python
class SafeCodeExecutor:
    def __init__(self):
        # å…è¨±çš„æ¨¡çµ„ç™½åå–®
        self.allowed_modules = {
            'numpy': numpy,
            'np': numpy,
            'scipy.integrate': scipy.integrate,
            'math': math
        }
        
    def execute_function(
        self,
        code: str,
        function_name: str = "f"
    ) -> callable:
        """
        å®‰å…¨åŸ·è¡Œç¨‹å¼ç¢¼ä¸¦è¿”å›å‡½æ•¸
        
        Args:
            code: AI ç”Ÿæˆçš„ç¨‹å¼ç¢¼
            function_name: è¦æå–çš„å‡½æ•¸åç¨±
            
        Returns:
            å¯å‘¼å«çš„å‡½æ•¸å°è±¡
        """
        # å»ºç«‹å—é™çš„ namespace
        exec_globals = self.allowed_modules.copy()
        
        try:
            # åŸ·è¡Œç¨‹å¼ç¢¼
            exec(code, exec_globals)
            
            # æå–å‡½æ•¸
            if function_name in exec_globals:
                return exec_globals[function_name]
            else:
                raise ValueError(f"å‡½æ•¸ {function_name} æœªå®šç¾©")
                
        except Exception as e:
            raise ExecutionError(f"ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—: {e}")
            
    def compute_coefficients(
        self,
        func: callable,
        period: float,
        n_terms: int
    ) -> dict:
        """
        æ•¸å€¼è¨ˆç®—å‚…ç«‹è‘‰ä¿‚æ•¸
        """
        omega0 = 2 * np.pi / period
        
        # è¨ˆç®— a0
        a0, _ = integrate.quad(func, 0, period)
        a0 = (2 / period) * a0
        
        # è¨ˆç®— an, bn
        an = []
        bn = []
        for n in range(1, n_terms + 1):
            # an ä¿‚æ•¸
            integrand_an = lambda t: func(t) * np.cos(n * omega0 * t)
            an_val, _ = integrate.quad(integrand_an, 0, period)
            an.append((2 / period) * an_val)
            
            # bn ä¿‚æ•¸
            integrand_bn = lambda t: func(t) * np.sin(n * omega0 * t)
            bn_val, _ = integrate.quad(integrand_bn, 0, period)
            bn.append((2 / period) * bn_val)
            
        return {
            "a0": float(a0),
            "an": [float(x) for x in an],
            "bn": [float(x) for x in bn]
        }
```

---

### 3.4 Verification Engineï¼ˆé©—è­‰å¼•æ“ï¼‰

**æª”æ¡ˆï¼š** `backend/app/core/verification.py`

**è·è²¬ï¼š**
- æ¯”å° AI çµæœèˆ‡æ•¸å€¼è¨ˆç®—çµæœ
- è¨ˆç®—èª¤å·®æŒ‡æ¨™
- ç”Ÿæˆèª¤å·®å ±å‘Š

**é—œéµæ–¹æ³•ï¼š**

```python
class VerificationEngine:
    def __init__(self, error_threshold: float = 0.01):
        self.error_threshold = error_threshold
        self.executor = SafeCodeExecutor()
        
    def verify(
        self,
        ai_response: dict,
        latex_input: str,
        period: float,
        n_terms: int
    ) -> dict:
        """
        å®Œæ•´çš„é©—è­‰æµç¨‹
        
        Returns:
            {
                "is_verified": bool,
                "error_metrics": dict,
                "error_report": dict,
                "numerical_result": dict
            }
        """
        
    def _compare_coefficients(
        self,
        ai_coeffs: dict,
        numerical_coeffs: dict
    ) -> dict:
        """
        æ¯”å°ä¿‚æ•¸ä¸¦è¨ˆç®—èª¤å·®
        
        Returns:
            {
                "a0_error": float,
                "an_errors": List[float],
                "bn_errors": List[float],
                "max_error": float,
                "relative_error": float
            }
        """
        
    def _generate_error_report(
        self,
        errors: dict,
        ai_coeffs: dict,
        numerical_coeffs: dict
    ) -> dict:
        """
        ç”Ÿæˆè©³ç´°çš„èª¤å·®å ±å‘Š
        
        Returns:
            {
                "summary": str,
                "details": List[str],
                "suggestions": List[str],
                "problematic_terms": List[int]
            }
        """
```

**èª¤å·®è¨ˆç®—é‚è¼¯ï¼š**

```python
def calculate_relative_error(ai_value, numerical_value):
    """è¨ˆç®—ç›¸å°èª¤å·®"""
    if abs(numerical_value) < 1e-10:
        # æ¥è¿‘é›¶ï¼Œä½¿ç”¨çµ•å°èª¤å·®
        return abs(ai_value - numerical_value)
    else:
        return abs(ai_value - numerical_value) / abs(numerical_value)

# å°æ‰€æœ‰ä¿‚æ•¸è¨ˆç®—èª¤å·®
max_error = max([
    calculate_relative_error(ai_coeffs['a0'], num_coeffs['a0']),
    max([calculate_relative_error(a_ai, a_num) 
         for a_ai, a_num in zip(ai_coeffs['an'], num_coeffs['an'])]),
    max([calculate_relative_error(b_ai, b_num) 
         for b_ai, b_num in zip(ai_coeffs['bn'], num_coeffs['bn'])])
])
```

---

### 3.5 Fourier Serviceï¼ˆä¸»è¦æ¥­å‹™é‚è¼¯ï¼‰

**æª”æ¡ˆï¼š** `backend/app/services/fourier_service.py`

**è·è²¬ï¼š**
- å”èª¿æ•´å€‹è¨ˆç®—æµç¨‹
- å¯¦ç¾è¿­ä»£æ©Ÿåˆ¶
- ç®¡ç†ç‹€æ…‹

**ä¸»è¦æµç¨‹ï¼š**

```python
class FourierSeriesService:
    def __init__(self):
        self.ai_engine = AIEngine(api_key=settings.CLAUDE_API_KEY)
        self.prompt_builder = PromptBuilder()
        self.verification = VerificationEngine()
        self.max_iterations = 5
        
    async def compute_with_verification(
        self,
        latex_input: str,
        period: float,
        n_terms: int
    ) -> dict:
        """
        å®Œæ•´çš„è¨ˆç®—èˆ‡é©—è­‰æµç¨‹
        
        Returns:
            {
                "success": bool,
                "iterations": int,
                "final_result": dict,
                "verification": dict,
                "history": List[dict]
            }
        """
        history = []
        
        for iteration in range(self.max_iterations):
            # 1. æ§‹å»º Prompt
            if iteration == 0:
                prompt = self.prompt_builder.build_initial_prompt(
                    latex_input, period, n_terms
                )
            else:
                prompt = self.prompt_builder.build_feedback_prompt(
                    latex_input, 
                    previous_response,
                    error_report
                )
            
            # 2. å‘¼å« AI
            ai_response = await self.ai_engine.derive_fourier_series(prompt)
            
            # 3. é©—è­‰
            verification_result = self.verification.verify(
                ai_response, latex_input, period, n_terms
            )
            
            # 4. è¨˜éŒ„æ­·å²
            history.append({
                "iteration": iteration + 1,
                "ai_response": ai_response,
                "verification": verification_result
            })
            
            # 5. åˆ¤æ–·æ˜¯å¦é€šé
            if verification_result["is_verified"]:
                return {
                    "success": True,
                    "iterations": iteration + 1,
                    "final_result": ai_response,
                    "verification": verification_result,
                    "history": history
                }
            
            # 6. æº–å‚™ä¸‹ä¸€æ¬¡è¿­ä»£
            previous_response = ai_response
            error_report = verification_result["error_report"]
        
        # é”åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•¸ä»æœªé€šé
        return {
            "success": False,
            "iterations": self.max_iterations,
            "final_result": ai_response,
            "verification": verification_result,
            "history": history,
            "error": "é”åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•¸ï¼Œä»ç„¡æ³•é”åˆ°ç²¾ç¢ºåº¦è¦æ±‚"
        }
```

---

## å››ã€API è¨­è¨ˆ

### 4.1 ä¸»è¦ API ç«¯é»

**æª”æ¡ˆï¼š** `backend/app/api/v1/derivation.py`

```python
from fastapi import APIRouter, HTTPException
from app.schemas.request import FourierRequest
from app.schemas.response import FourierResponse
from app.services.fourier_service import FourierSeriesService

router = APIRouter()
service = FourierSeriesService()

@router.post("/fourier-series", response_model=FourierResponse)
async def compute_fourier_series(request: FourierRequest):
    """
    è¨ˆç®—å‚…ç«‹è‘‰ç´šæ•¸
    
    Request Body:
        - latex_input: str (LaTeX æ ¼å¼çš„å‡½æ•¸)
        - period: float (é€±æœŸ)
        - n_terms: int (è¨ˆç®—é …æ•¸)
        
    Response:
        - thinking_process: æ¨å°éç¨‹ï¼ˆçµ¦å‰ç«¯å±•ç¤ºï¼‰
        - code_display: ç¨‹å¼ç¢¼ï¼ˆçµ¦å‰ç«¯å±•ç¤ºï¼‰
        - final_result: æœ€çµ‚ LaTeX å…¬å¼
        - verification: é©—è­‰çµæœ
        - visualization_data: åœ–è¡¨æ•¸æ“š
    """
    try:
        result = await service.compute_with_verification(
            request.latex_input,
            request.period,
            request.n_terms
        )
        
        if not result["success"]:
            raise HTTPException(status_code=422, detail=result["error"])
        
        # çµ„è£è¿”å›çµ¦å‰ç«¯çš„æ•¸æ“š
        return FourierResponse(
            thinking_process=result["final_result"]["thinking_process"],
            code_display=_format_code_for_display(
                result["final_result"]["executable_code"]
            ),
            final_result=result["final_result"]["final_result"],
            verification=result["verification"],
            iterations=result["iterations"],
            history=result["history"]
        )
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 4.2 Request/Response Schemas

**æª”æ¡ˆï¼š** `backend/app/schemas/request.py`

```python
from pydantic import BaseModel, Field

class FourierRequest(BaseModel):
    latex_input: str = Field(..., description="LaTeX æ ¼å¼çš„å‡½æ•¸")
    period: float = Field(..., gt=0, description="å‡½æ•¸é€±æœŸ")
    n_terms: int = Field(..., ge=1, le=20, description="è¨ˆç®—é …æ•¸")
    
    class Config:
        json_schema_extra = {
            "example": {
                "latex_input": "\\sin(t)",
                "period": 6.283185,
                "n_terms": 5
            }
        }
```

**æª”æ¡ˆï¼š** `backend/app/schemas/response.py`

```python
from pydantic import BaseModel
from typing import List, Dict, Any

class ThinkingStep(BaseModel):
    step_number: int
    title: str
    reasoning: str
    formula_latex: str
    calculation_steps: List[str]
    result: Dict[str, Any]

class ThinkingProcess(BaseModel):
    steps: List[ThinkingStep]

class VerificationResult(BaseModel):
    is_verified: bool
    error_metrics: Dict[str, float]
    error_report: Dict[str, Any]

class FourierResponse(BaseModel):
    thinking_process: ThinkingProcess
    code_display: str
    final_result: Dict[str, str]
    verification: VerificationResult
    iterations: int
```

---

## äº”ã€è³‡æ–™åº«è¨­è¨ˆ

### 5.1 Schema è¨­è¨ˆ

```sql
-- å•é¡Œè¡¨
CREATE TABLE problems (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    latex_input TEXT NOT NULL,
    period FLOAT NOT NULL,
    n_terms INTEGER NOT NULL,
    category VARCHAR(50) DEFAULT 'fourier_series',
    created_at TIMESTAMP DEFAULT NOW()
);

-- AI è§£ç­”è¡¨
CREATE TABLE ai_solutions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    problem_id UUID REFERENCES problems(id),
    thinking_process JSONB NOT NULL,
    executable_code JSONB NOT NULL,
    coefficients JSONB NOT NULL,
    final_latex TEXT NOT NULL,
    iterations INTEGER DEFAULT 1,
    computation_time FLOAT,  -- ç§’
    created_at TIMESTAMP DEFAULT NOW()
);

-- é©—è­‰è¨˜éŒ„è¡¨
CREATE TABLE verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    solution_id UUID REFERENCES ai_solutions(id),
    is_verified BOOLEAN NOT NULL,
    error_metrics JSONB NOT NULL,
    numerical_result JSONB NOT NULL,
    error_report JSONB,
    verified_at TIMESTAMP DEFAULT NOW()
);

-- è¿­ä»£æ­·å²è¡¨ï¼ˆç”¨æ–¼åˆ†æï¼‰
CREATE TABLE iteration_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    solution_id UUID REFERENCES ai_solutions(id),
    iteration_number INTEGER NOT NULL,
    ai_response JSONB NOT NULL,
    verification_result JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_problems_category ON problems(category);
CREATE INDEX idx_solutions_problem ON ai_solutions(problem_id);
CREATE INDEX idx_verifications_solution ON verifications(solution_id);
```

---

## å…­ã€å‰ç«¯å¯¦ä½œå»ºè­°

### 6.1 æ ¸å¿ƒçµ„ä»¶

**1. Thinking Process Displayï¼ˆæ¨å°éç¨‹å±•ç¤ºï¼‰**

```typescript
// components/thinking-display/StepCard.tsx
interface StepCardProps {
  step: ThinkingStep;
  isExpanded: boolean;
  onToggle: () => void;
}

export function StepCard({ step, isExpanded, onToggle }: StepCardProps) {
  return (
    <Card>
      <CardHeader onClick={onToggle}>
        <h3>æ­¥é©Ÿ {step.step_number}: {step.title}</h3>
      </CardHeader>
      {isExpanded && (
        <CardContent>
          <p>{step.reasoning}</p>
          <MathDisplay latex={step.formula_latex} />
          {step.calculation_steps.map((calc, i) => (
            <MathDisplay key={i} latex={calc} />
          ))}
          <Result>
            <MathDisplay latex={step.result.latex} />
          </Result>
        </CardContent>
      )}
    </Card>
  );
}
```

**2. Visualization Componentï¼ˆè¦–è¦ºåŒ–çµ„ä»¶ï¼‰**

```typescript
// components/visualization/ComparisonView.tsx
import Plot from 'react-plotly.js';

interface ComparisonViewProps {
  originalData: number[];
  reconstructedData: number[];
  timePoints: number[];
}

export function ComparisonView({ 
  originalData, 
  reconstructedData, 
  timePoints 
}: ComparisonViewProps) {
  const plotData = [
    {
      x: timePoints,
      y: originalData,
      type: 'scatter',
      mode: 'lines',
      name: 'åŸå§‹å‡½æ•¸',
      line: { color: 'blue' }
    },
    {
      x: timePoints,
      y: reconstructedData,
      type: 'scatter',
      mode: 'lines',
      name: 'é‡å»ºå‡½æ•¸',
      line: { color: 'red', dash: 'dash' }
    }
  ];
  
  return <Plot data={plotData} layout={{...}} />;
}
```

### 6.2 ç‹€æ…‹ç®¡ç†

```typescript
// stores/problem-store.ts
import { create } from 'zustand';

interface ProblemState {
  latexInput: string;
  period: number;
  nTerms: number;
  result: FourierResponse | null;
  isLoading: boolean;
  
  setLatexInput: (input: string) => void;
  setPeriod: (period: number) => void;
  setNTerms: (n: number) => void;
  computeFourierSeries: () => Promise<void>;
}

export const useProblemStore = create<ProblemState>((set, get) => ({
  latexInput: '',
  period: 2 * Math.PI,
  nTerms: 5,
  result: null,
  isLoading: false,
  
  setLatexInput: (input) => set({ latexInput: input }),
  setPeriod: (period) => set({ period }),
  setNTerms: (n) => set({ nTerms: n }),
  
  computeFourierSeries: async () => {
    set({ isLoading: true });
    try {
      const { latexInput, period, nTerms } = get();
      const response = await api.computeFourierSeries({
        latexInput,
        period,
        nTerms
      });
      set({ result: response, isLoading: false });
    } catch (error) {
      set({ isLoading: false });
      // éŒ¯èª¤è™•ç†
    }
  }
}));
```

---

## ä¸ƒã€éƒ¨ç½²å»ºè­°

### 7.1 é–‹ç™¼ç’°å¢ƒè¨­ç½®

```bash
# å‰ç«¯
cd frontend
npm install
npm run dev  # http://localhost:3000

# å¾Œç«¯
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --reload  # http://localhost:8000
```

### 7.2 ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

**å‰ç«¯ï¼ˆVercelï¼‰ï¼š**
```bash
# é€£æ¥ GitHub repo
# Vercel è‡ªå‹•æª¢æ¸¬ Next.js
# è¨­å®šç’°å¢ƒè®Šæ•¸: NEXT_PUBLIC_API_URL

vercel deploy
```

**å¾Œç«¯ï¼ˆRailwayï¼‰ï¼š**
```bash
# å‰µå»º railway.json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "restartPolicyType": "ON_FAILURE"
  }
}

# è¨­å®šç’°å¢ƒè®Šæ•¸:
CLAUDE_API_KEY=xxx
DATABASE_URL=xxx
REDIS_URL=xxx

# éƒ¨ç½²
railway up
```

---

## å…«ã€æ¸¬è©¦ç­–ç•¥

### 8.1 å–®å…ƒæ¸¬è©¦

```python
# tests/test_verification.py
import pytest
from app.core.verification import VerificationEngine

def test_compare_coefficients_exact_match():
    """æ¸¬è©¦ä¿‚æ•¸å®Œå…¨åŒ¹é…"""
    engine = VerificationEngine()
    
    ai_coeffs = {"a0": 0.0, "an": [0.0, 0.0], "bn": [1.0, 0.0]}
    num_coeffs = {"a0": 0.0, "an": [0.0, 0.0], "bn": [1.0, 0.0]}
    
    result = engine._compare_coefficients(ai_coeffs, num_coeffs)
    
    assert result["max_error"] < 1e-10
    assert result["relative_error"] < 1e-10

def test_compare_coefficients_with_error():
    """æ¸¬è©¦æœ‰èª¤å·®çš„æƒ…æ³"""
    engine = VerificationEngine(error_threshold=0.05)
    
    ai_coeffs = {"a0": 0.0, "an": [0.1, 0.0], "bn": [1.0, 0.0]}
    num_coeffs = {"a0": 0.0, "an": [0.0, 0.0], "bn": [1.0, 0.0]}
    
    result = engine._compare_coefficients(ai_coeffs, num_coeffs)
    
    assert result["max_error"] > 0.05
```

### 8.2 æ•´åˆæ¸¬è©¦

```python
# tests/test_fourier_service.py
@pytest.mark.asyncio
async def test_full_computation_flow():
    """æ¸¬è©¦å®Œæ•´çš„è¨ˆç®—æµç¨‹"""
    service = FourierSeriesService()
    
    result = await service.compute_with_verification(
        latex_input="\\sin(t)",
        period=2 * np.pi,
        n_terms=5
    )
    
    assert result["success"] == True
    assert result["iterations"] <= 5
    assert result["verification"]["is_verified"] == True
```

---

## ä¹ã€ç›£æ§èˆ‡æ—¥èªŒ

### 9.1 æ—¥èªŒè¨­è¨ˆ

```python
import logging
import structlog

# é…ç½®çµæ§‹åŒ–æ—¥èªŒ
structlog.configure(
    processors=[
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.JSONRenderer()
    ]
)

logger = structlog.get_logger()

# ä½¿ç”¨ç¯„ä¾‹
logger.info(
    "ai_derivation_completed",
    problem_id=problem_id,
    iterations=iterations,
    error=error_percentage,
    computation_time=elapsed_time
)
```

### 9.2 é—œéµæŒ‡æ¨™ç›£æ§

```python
# éœ€è¦ç›£æ§çš„æŒ‡æ¨™
- AI API å‘¼å«æ¬¡æ•¸
- å¹³å‡éŸ¿æ‡‰æ™‚é–“
- é©—è­‰é€šéç‡
- å¹³å‡è¿­ä»£æ¬¡æ•¸
- éŒ¯èª¤ç‡
```

---

## åã€ç¸½çµèˆ‡å»ºè­°

### 10.1 å¯¦ä½œå„ªå…ˆé †åº

**Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3é€±ï¼‰**
1. Prompt Builder
2. AI Engine
3. Code Executor
4. Verification Engine
5. åŸºæœ¬ API

**Phase 2: å‰ç«¯é–‹ç™¼ï¼ˆ2é€±ï¼‰**
1. LaTeX ç·¨è¼¯å™¨
2. Thinking Display
3. è¦–è¦ºåŒ–çµ„ä»¶
4. API æ•´åˆ

**Phase 3: å„ªåŒ–èˆ‡æ¸¬è©¦ï¼ˆ1é€±ï¼‰**
1. èª¤å·®è¿­ä»£å„ªåŒ–
2. å–®å…ƒæ¸¬è©¦
3. æ•´åˆæ¸¬è©¦

**Phase 4: éƒ¨ç½²ï¼ˆ1é€±ï¼‰**
1. ç’°å¢ƒé…ç½®
2. CI/CD
3. ç›£æ§è¨­ç½®

### 10.2 é—œéµæ³¨æ„äº‹é …

1. **Prompt æ˜¯æ ¸å¿ƒ**
   - èŠ±æ™‚é–“æ¸¬è©¦å’Œå„ªåŒ– Prompt
   - ç¢ºä¿è¼¸å‡ºæ ¼å¼ç©©å®š
   - Few-shot ç¯„ä¾‹å¾ˆé‡è¦

2. **å®‰å…¨åŸ·è¡Œ**
   - æ°¸é ä¸è¦ç›´æ¥åŸ·è¡Œæœªé©—è­‰çš„ç¨‹å¼ç¢¼
   - ä½¿ç”¨æ²™ç®±æˆ–å—é™ç’°å¢ƒ
   - è¨­ç½®è¶…æ™‚æ©Ÿåˆ¶

3. **èª¤å·®é–¾å€¼**
   - æ ¹æ“šå¯¦éš›æ¸¬è©¦èª¿æ•´é–¾å€¼
   - ä¸åŒå‡½æ•¸å¯èƒ½éœ€è¦ä¸åŒé–¾å€¼
   - è¨˜éŒ„èª¤å·®åˆ†å¸ƒä»¥ä¾¿åˆ†æ

4. **ä½¿ç”¨è€…é«”é©—**
   - æä¾›å³æ™‚åé¥‹
   - è¼‰å…¥ç‹€æ…‹è¦æ¸…æ¥š
   - éŒ¯èª¤è¨Šæ¯è¦å‹å–„

---

é€™ä»½å ±å‘Šæä¾›äº†å…·é«”çš„å¯¦ä½œå»ºè­°ï¼Œä½† Claude Code å¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´ã€‚é—œéµæ˜¯ä¿æŒæ ¸å¿ƒè¨­è¨ˆåŸå‰‡ï¼š**é›™è»Œè¼¸å‡º** å’Œ **é–‰ç’°é©—è­‰**ã€‚ğŸš€