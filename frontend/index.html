<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Calculator V2 - Fourier Series</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .computing-section {
            display: none;
        }

        .progress-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e0e0e0;
        }

        .progress-step.active {
            border-left-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .progress-step.complete {
            border-left-color: #28a745;
        }

        .step-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .derivation-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .derivation-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 16px;
        }

        .derivation-content h2 {
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .derivation-content h2:first-child {
            margin-top: 0;
        }

        .derivation-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .derivation-streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #667eea;
            animation: blink 1s infinite;
            margin-left: 4px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .results {
            display: none;
        }

        .result-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .result-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .verification-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .verification-pass {
            background: #d4edda;
            color: #155724;
        }

        .verification-warning {
            background: #fff3cd;
            color: #856404;
        }

        .verification-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 AI Calculator <span class="badge">V2</span></h1>
        <p class="subtitle">透明化的 AI 數學推理 - 傅立葉級數計算（流式輸出版）</p>

        <div class="input-section">
            <h2 style="margin-bottom: 20px; color: #333;">輸入函數</h2>

            <div class="form-group">
                <label for="functionExpr">函數表達式 (Python 語法)</label>
                <input type="text" id="functionExpr" value="np.sin(t)" placeholder="例如: np.sin(t), np.cos(2*t), t**2">
                <div class="hint">使用 np.sin, np.cos, np.exp 等 NumPy 函數。變數必須是 t。</div>
            </div>

            <div class="form-group">
                <label for="period">週期 (T)</label>
                <input type="number" id="period" value="6.283185" step="0.000001" placeholder="例如: 6.283185 (2π)">
                <div class="hint">函數的週期，例如 sin(t) 的週期是 2π ≈ 6.283185</div>
            </div>

            <div class="form-group">
                <label for="nTerms">項數 (n)</label>
                <input type="number" id="nTerms" value="3" min="1" max="20" placeholder="1-20">
                <div class="hint">計算傅立葉級數的項數 (1-20)</div>
            </div>

            <button id="computeBtn" onclick="computeFourier()">開始計算</button>
        </div>

        <!-- Computing Progress Section -->
        <div class="computing-section" id="computingSection">
            <div class="progress-container">
                <h2 style="margin-bottom: 20px; color: #333;">⚡ 計算進度</h2>
                <div id="progressSteps"></div>
            </div>

            <!-- Live Derivation Display -->
            <div class="derivation-section" id="derivationSection" style="display:none;">
                <h2 style="margin-bottom: 15px; color: #333;">📖 AI 推導過程（實時）</h2>
                <div class="derivation-content" id="derivationContent"></div>
            </div>
        </div>

        <!-- Final Results Section -->
        <div class="results" id="results">
            <div id="statusMessage"></div>

            <div class="result-section">
                <h2>📊 驗證結果</h2>
                <div id="verificationInfo"></div>
            </div>

            <div class="result-section">
                <h2>📈 視覺化比較</h2>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <div class="result-section">
                <h2>📉 逐點誤差</h2>
                <div class="chart-container">
                    <canvas id="errorChart"></canvas>
                </div>
            </div>

            <div class="result-section">
                <h2>🤔 完整推導過程</h2>
                <div id="finalDerivation" class="derivation-content"></div>
            </div>
        </div>

        <div id="errorContainer"></div>
    </div>

    <script>
        // ==================== 配置區域 ====================
        // 部署到 Cloudflare 時，請修改 BACKEND_URL
        const API_CONFIG = {
            // 本地開發
            LOCAL: 'http://localhost:8000',
            // 生產環境 - 請在部署前修改為你的後端 URL
            // 例如：'https://your-app.railway.app' 或 'https://your-backend.com'
            PRODUCTION: 'YOUR_BACKEND_URL_HERE',  // ⚠️ 部署時必須修改這裡！
        };

        // 自動檢測環境
        const isLocalhost = window.location.hostname === 'localhost' ||
                            window.location.hostname === '127.0.0.1' ||
                            window.location.hostname === '';

        const BACKEND_URL = isLocalhost ? API_CONFIG.LOCAL : API_CONFIG.PRODUCTION;

        // 顯示當前配置（方便除錯）
        console.log('🔧 API Configuration:', {
            hostname: window.location.hostname,
            isLocalhost: isLocalhost,
            backendURL: BACKEND_URL
        });

        // 檢查生產環境是否配置了後端 URL
        if (!isLocalhost && BACKEND_URL === 'YOUR_BACKEND_URL_HERE') {
            console.error('⚠️ 警告：尚未配置生產環境的後端 URL！');
            alert('錯誤：尚未配置後端 API 地址。\n\n請修改 index_v2.html 中的 API_CONFIG.PRODUCTION');
        }
        // ==================== 配置區域結束 ====================

        let comparisonChart = null;
        let errorChart = null;
        let eventSource = null;
        let sessionData = {
            derivation: '',
            verification: null,
            visualization: null,
            iterations: 0
        };

        // Progress steps configuration
        const PROGRESS_STEPS = {
            session_created: { icon: '🎯', text: 'Session 已建立' },
            derivation_chunk: { icon: '📝', text: 'AI 正在推導...' },
            derivation_complete: { icon: '✅', text: '推導完成' },
            code_generated: { icon: '💻', text: '代碼生成完成' },
            verification_result: { icon: '🔍', text: '驗證中...' },
            error_analysis: { icon: '🧠', text: 'AI 錯誤分析' },
            success: { icon: '🎉', text: '計算成功！' },
            success_with_warning: { icon: '⚠️', text: '完成（有警告）' },
            failed: { icon: '❌', text: '計算失敗' }
        };

        function updateProgressStep(type, message) {
            const config = PROGRESS_STEPS[type];
            if (!config) return;

            const container = document.getElementById('progressSteps');
            const stepId = `step-${type}`;  // Fixed ID without timestamp

            // Check if step already exists
            let stepElement = document.getElementById(stepId);

            if (stepElement) {
                // Update existing step
                const contentDiv = stepElement.querySelector('div:last-child');
                if (contentDiv) {
                    contentDiv.innerHTML = `
                        <strong>${config.text}</strong>
                        ${message ? `<div style="color: #666; font-size: 0.9em; margin-top: 4px;">${message}</div>` : ''}
                    `;
                }
            } else {
                // Create new step
                // Mark previous steps as complete
                document.querySelectorAll('.progress-step.active').forEach(el => {
                    el.classList.remove('active');
                    el.classList.add('complete');
                });

                const stepHtml = `
                    <div class="progress-step active" id="${stepId}">
                        <div class="step-icon">${config.icon}</div>
                        <div>
                            <strong>${config.text}</strong>
                            ${message ? `<div style="color: #666; font-size: 0.9em; margin-top: 4px;">${message}</div>` : ''}
                        </div>
                    </div>
                `;

                container.innerHTML += stepHtml;
            }

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function appendDerivationChunk(chunk) {
            const derivationSection = document.getElementById('derivationSection');
            const derivationContent = document.getElementById('derivationContent');

            derivationSection.style.display = 'block';

            // Append chunk
            sessionData.derivation += chunk;

            // Parse Markdown and render
            const html = marked.parse(sessionData.derivation);
            derivationContent.innerHTML = html + '<span class="derivation-streaming-indicator"></span>';

            // Trigger MathJax to re-render math
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([derivationContent]).catch((err) => console.log('MathJax error:', err));
            }

            // Auto-scroll
            derivationContent.scrollTop = derivationContent.scrollHeight;
        }

        function completeDerivation() {
            const derivationContent = document.getElementById('derivationContent');

            // Remove streaming indicator
            const html = marked.parse(sessionData.derivation);
            derivationContent.innerHTML = html;

            // Final MathJax render
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([derivationContent]).catch((err) => console.log('MathJax error:', err));
            }
        }

        async function computeFourier() {
            const functionExpr = document.getElementById('functionExpr').value;
            const period = parseFloat(document.getElementById('period').value);
            const nTerms = parseInt(document.getElementById('nTerms').value);

            // Validation
            if (!functionExpr || !period || !nTerms) {
                alert('請填寫所有欄位');
                return;
            }

            // Reset
            document.getElementById('computeBtn').disabled = true;
            document.getElementById('computingSection').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('progressSteps').innerHTML = '';
            document.getElementById('derivationSection').style.display = 'none';
            sessionData = { derivation: '', verification: null, visualization: null, iterations: 0 };

            // Close existing EventSource
            if (eventSource) {
                eventSource.close();
            }

            try {
                // Use EventSource for SSE
                const url = new URL(`${BACKEND_URL}/api/v2/fourier-series/stream`);

                // Create EventSource with POST data (workaround: use sync endpoint for now)
                // EventSource doesn't support POST, so we'll use fetch with stream
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        function_expr: functionExpr,
                        period: period,
                        n_terms: nTerms
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            try {
                                const event = JSON.parse(data);
                                handleEvent(event);
                            } catch (e) {
                                console.error('JSON parse error:', e, data);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorContainer').innerHTML = `
                    <div class="error-message">
                        <strong>錯誤：</strong> ${error.message}
                    </div>
                `;
            } finally {
                document.getElementById('computeBtn').disabled = false;
            }
        }

        function handleEvent(event) {
            console.log('Event:', event);

            switch (event.type) {
                case 'session_created':
                    updateProgressStep('session_created', `Session ID: ${event.session_id}`);
                    break;

                case 'iteration_start':
                    sessionData.iterations = event.iteration;
                    updateProgressStep('iteration_start', `迭代 ${event.iteration}`);
                    // Reset derivation for new iteration
                    if (event.iteration > 1) {
                        sessionData.derivation = '';
                        document.getElementById('derivationContent').innerHTML = '';
                    }
                    break;

                case 'derivation_chunk':
                    appendDerivationChunk(event.content);
                    updateProgressStep('derivation_chunk');
                    break;

                case 'derivation_complete':
                    completeDerivation();
                    updateProgressStep('derivation_complete', `${sessionData.derivation.length} 字元`);
                    break;

                case 'code_generated':
                    updateProgressStep('code_generated');
                    console.log('Generated code:', event.code);
                    break;

                case 'verification_result':
                    sessionData.verification = event.result;
                    const verified = event.result.is_verified;
                    const maxError = event.result.error_metrics?.max_relative_error || 0;
                    updateProgressStep('verification_result',
                        verified ? `✓ 通過 (誤差: ${(maxError * 100).toFixed(4)}%)` : '✗ 未通過');
                    break;

                case 'error_analysis':
                    const analysis = event.analysis;
                    updateProgressStep('error_analysis',
                        `${analysis.error_category} (${analysis.severity})`);
                    break;

                case 'success':
                case 'success_with_warning':
                    updateProgressStep(event.type);
                    displayFinalResults(event.result);
                    break;

                case 'failed':
                case 'max_iterations_reached':
                    updateProgressStep(event.type, event.reason || event.message);
                    showError(event.reason || '達到最大迭代次數');
                    break;

                default:
                    console.log('Unknown event type:', event.type);
            }
        }

        function displayFinalResults(result) {
            // Show results section
            document.getElementById('results').style.display = 'block';

            // Status message
            let statusHtml = '';
            if (result.success === false && result.status === 'acceptable_error') {
                statusHtml = `
                    <div class="info-message">
                        ℹ️ ${result.error_analysis?.explanation || '計算完成，存在可接受的誤差'}
                        <br><small>${result.error_analysis?.suggestion_to_user || ''}</small>
                    </div>
                `;
            } else if (sessionData.iterations > 1) {
                statusHtml = `
                    <div class="info-message">
                        ✓ AI 經過 ${sessionData.iterations} 次迭代後成功計算
                    </div>
                `;
            }
            document.getElementById('statusMessage').innerHTML = statusHtml;

            // Verification info
            if (result.verification || sessionData.verification) {
                const verification = result.verification || sessionData.verification;
                const maxError = verification.error_metrics?.max_relative_error || verification.max_relative_error || 0;
                const meanError = verification.error_metrics?.mean_relative_error || verification.mean_relative_error || 0;

                let badgeClass = 'verification-pass';
                let badgeText = '✓ 驗證通過';

                if (!verification.is_verified) {
                    if (result.status === 'acceptable_error') {
                        badgeClass = 'verification-warning';
                        badgeText = '⚠️ 可接受的誤差';
                    } else {
                        badgeClass = 'verification-fail';
                        badgeText = '✗ 驗證失敗';
                    }
                }

                document.getElementById('verificationInfo').innerHTML = `
                    <div class="verification-badge ${badgeClass}">${badgeText}</div>
                    <p><strong>最大相對誤差:</strong> ${(maxError * 100).toFixed(6)}%</p>
                    <p><strong>平均相對誤差:</strong> ${(meanError * 100).toFixed(6)}%</p>
                `;
            }

            // Visualization
            if (result.visualization) {
                displayCharts(result.visualization);
            }

            // Final derivation
            if (result.derivation || sessionData.derivation) {
                const derivation = result.derivation || sessionData.derivation;
                const html = marked.parse(derivation);
                document.getElementById('finalDerivation').innerHTML = html;

                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([document.getElementById('finalDerivation')])
                        .catch((err) => console.log('MathJax error:', err));
                }
            }
        }

        function displayCharts(vizData) {
            if (!vizData || !vizData.t_points) return;

            // Comparison chart
            const comparisonCtx = document.getElementById('comparisonChart');
            if (comparisonChart) {
                comparisonChart.destroy();
            }

            comparisonChart = new Chart(comparisonCtx, {
                type: 'line',
                data: {
                    labels: vizData.t_points,
                    datasets: [
                        {
                            label: '原始函數',
                            data: vizData.original_values,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: '傅立葉重建',
                            data: vizData.reconstructed_values,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '原始函數 vs 傅立葉級數重建'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 't' },
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            title: { display: true, text: 'f(t)' }
                        }
                    }
                }
            });

            // Error chart
            const errorCtx = document.getElementById('errorChart');
            if (errorChart) {
                errorChart.destroy();
            }

            errorChart = new Chart(errorCtx, {
                type: 'line',
                data: {
                    labels: vizData.t_points,
                    datasets: [{
                        label: '逐點誤差',
                        data: vizData.pointwise_error || vizData.pointwise_errors,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `逐點誤差 (最大: ${(vizData.max_pointwise_error || 0).toFixed(6)})`
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 't' },
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            title: { display: true, text: '|誤差|' }
                        }
                    }
                }
            });
        }

        function showError(message) {
            document.getElementById('errorContainer').innerHTML = `
                <div class="error-message">
                    <strong>錯誤：</strong> ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
